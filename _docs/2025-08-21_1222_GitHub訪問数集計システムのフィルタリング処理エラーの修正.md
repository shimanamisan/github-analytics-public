# GitHub訪問数集計システムのフィルタリング処理エラーの修正

## 概要

GitHub訪問数集計システムにおいて、URLパラメータ付きのリクエスト時に「Illegal operator and value combination」エラーが発生し、チャートが表示されない問題が発生していました。本ドキュメントでは、問題の背景、原因、修正内容について詳しく説明します。

## 問題の背景

### 発生していたエラー
```
InvalidArgumentException: Illegal operator and value combination.
at /workspace/src/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:956
```

### 問題が発生する条件
- **正常動作**: `http://api.example.com/github/views` → データが正常に取得され、チャートが表示される
- **エラー発生**: `http://api.example.com/github/views?project=shimanamisan%2FCsharpSample&start_date=&end_date=` → エラーが発生し、チャートが表示されない

### エラーの詳細
ログファイルから以下の情報が確認できました：
```json
{
  "project": "shimanamisan/CsharpSample",
  "repository_id": null,
  "start_date": null,
  "end_date": null,
  "has_project": true,
  "filled_project": true,
  "project_type": "string",
  "project_empty": false
}
```

## 問題の原因

### 1. Laravelミドルウェアの動作
Laravelの`ConvertEmptyStringsToNull`ミドルウェアが、空文字列（`""`）を`null`に変換していました。

### 2. 不適切な値チェック
元のコードでは以下のようなチェックを行っていました：
```php
if ($request->has('start_date') && $request->start_date !== '') {
    $query->where('date', '>=', $request->start_date);
}
```

しかし、実際には`$request->start_date`が`null`になっていたため、`$request->start_date !== ''`のチェックが機能せず、`where('date', '>=', NULL)`が実行されていました。

### 3. データベースクエリエラー
`NULL`値との比較演算子（`>=`, `<=`）の組み合わせが無効であるため、データベースエラーが発生していました。

## 修正内容

### 1. 日付フィルタリングの修正
**修正前:**
```php
// 日付範囲でフィルタリング（空文字列の場合はフィルタリングしない）
if ($request->has('start_date') && $request->start_date !== '') {
    $query->where('date', '>=', $request->start_date);
}

if ($request->has('end_date') && $request->end_date !== '') {
    $query->where('date', '<=', $request->end_date);
}
```

**修正後:**
```php
// 日付範囲でフィルタリング（nullや空文字列の場合はフィルタリングしない）
if ($request->filled('start_date')) {
    $query->where('date', '>=', $request->start_date);
}

if ($request->filled('end_date')) {
    $query->where('date', '<=', $request->end_date);
}
```

### 2. チャートデータ生成の修正
**修正前:**
```php
$startDate = ($request->has('start_date') && $request->start_date !== '') ? $request->start_date : now()->subDays(30)->format('Y-m-d');
$endDate = ($request->has('end_date') && $request->end_date !== '') ? $request->end_date : now()->format('Y-m-d');
```

**修正後:**
```php
$startDate = $request->filled('start_date') ? $request->start_date : now()->subDays(30)->format('Y-m-d');
$endDate = $request->filled('end_date') ? $request->end_date : now()->format('Y-m-d');
```

### 3. プロジェクトパラメータの検証強化
プロジェクトフィルタリングの安全性を向上させるため、値の検証を追加しました：

```php
if ($request->filled('project')) {
    $project = $request->project;
    \Log::info('Applying project filter', ['project' => $project]);
    
    // プロジェクト名の検証
    if (is_string($project) && !empty(trim($project))) {
        $query->forProject(trim($project));
    } else {
        \Log::warning('Invalid project parameter', ['project' => $project]);
    }
}
```

## 修正のポイント

### 1. `filled()`メソッドの使用
- `null`値を適切に処理
- 空文字列を適切に処理
- 空白文字のみの文字列を適切に処理
- Laravelの標準的な方法

### 2. 一貫性の確保
- メインクエリ、チャートクエリ、統計クエリのすべてで同じロジックを使用
- フィルタリング処理の統一

### 3. デバッグ情報の追加
- 各段階でパラメータの値をログに出力
- 問題の早期発見と原因特定の支援

## 修正後の動作

### 期待される動作
- `?project=shimanamisan%2FCsharpSample&start_date=&end_date=`のようなリクエストでも、空の日付パラメータは無視され、デフォルトの過去30日のデータが表示される
- プロジェクトフィルタリングは正常に動作し、指定されたリポジトリのデータのみが表示される
- `Illegal operator and value combination`エラーが発生しない

### フィルタリングの動作
1. **プロジェクト指定あり**: 指定されたプロジェクトのデータのみを表示
2. **日付範囲指定なし**: 過去30日のデータを表示（デフォルト）
3. **日付範囲指定あり**: 指定された期間のデータを表示

## 影響範囲

### 修正されたファイル
- `src/app/Http/Controllers/GitHubViewController.php`

### 修正されたメソッド
- `index()`: メインページの表示
- `chart()`: チャート用JSONデータの取得

### 修正された処理
- 日付フィルタリング
- プロジェクトフィルタリング
- チャートデータ生成
- 統計情報生成

## 今後の注意点

### 1. パラメータの検証
- リクエストパラメータの値は適切に検証する
- `filled()`メソッドを使用して、有効な値のみを処理する

### 2. ログ出力の活用
- デバッグ情報を適切にログに出力する
- 問題発生時の原因特定を支援する

### 3. 一貫性の維持
- フィルタリング処理は統一されたロジックを使用する
- 同様の処理は同じパターンで実装する

## 結論

今回の問題は、Laravelミドルウェアの動作と不適切な値チェックの組み合わせにより発生していました。`filled()`メソッドを使用することで、`null`値や空文字列を適切に処理し、データベースエラーを防ぐことができました。

この修正により、GitHub訪問数集計システムのフィルタリング機能が正常に動作し、ユーザーは期待通りの結果を得られるようになりました。
