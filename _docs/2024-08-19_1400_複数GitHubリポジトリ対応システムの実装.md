# 複数GitHubリポジトリ対応システムの実装

**日付**: 2024年8月19日 14:00  
**タイトル**: 複数GitHubリポジトリ対応システムの実装  
**担当者**: AI Assistant  

## 📋 概要

従来の単一リポジトリ管理から、複数のGitHubリポジトリを効率的に管理・監視できるシステムへの移行を実装しました。

## 🔄 変更前の状況

### 問題点
- **単一リポジトリのみ対応**: `.env`ファイルで`GITHUB_REPO`を指定する必要
- **ハードコーディング**: リポジトリ情報が環境設定に固定
- **拡張性の欠如**: 新しいリポジトリを追加する際の柔軟性不足
- **データ管理の限界**: リポジトリごとの個別設定や管理が困難

### 従来の設定
```env
GITHUB_TOKEN=your_token
GITHUB_OWNER=shimanamisan
GITHUB_REPO=CsharpSample
```

## 🚀 実装された変更内容

### 1. データベース設計の変更

#### 新規テーブル: `github_repositories`
```sql
CREATE TABLE github_repositories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    owner VARCHAR(255) NOT NULL COMMENT 'GitHubリポジトリのオーナー名',
    repo VARCHAR(255) NOT NULL COMMENT 'GitHubリポジトリ名',
    name VARCHAR(255) NULL COMMENT '表示用の名前',
    description TEXT NULL COMMENT '説明',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'データ取得の有効/無効',
    github_token VARCHAR(255) NULL COMMENT 'リポジトリ専用のGitHubトークン',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_owner_repo (owner, repo),
    INDEX idx_is_active (is_active),
    INDEX idx_owner (owner)
);
```

#### 既存テーブルの更新: `github_views`
```sql
-- 新規カラム追加
ALTER TABLE github_views ADD COLUMN repository_id BIGINT UNSIGNED NULL AFTER id;

-- 外部キー制約
ALTER TABLE github_views ADD CONSTRAINT fk_github_views_repository_id 
    FOREIGN KEY (repository_id) REFERENCES github_repositories(id) ON DELETE CASCADE;

-- インデックス追加
CREATE INDEX idx_repository_date ON github_views (repository_id, date);
```

### 2. モデルの更新

#### 新規モデル: `GitHubRepository`
```php
class GitHubRepository extends Model
{
    protected $table = 'github_repositories';
    
    protected $fillable = [
        'owner', 'repo', 'name', 'description', 
        'is_active', 'github_token'
    ];
    
    // リレーション
    public function gitHubViews(): HasMany
    {
        return $this->hasMany(GitHubView::class, 'repository_id');
    }
    
    // アクセサ
    public function getFullNameAttribute(): string
    {
        return "{$this->owner}/{$this->repo}";
    }
    
    public function getDisplayNameAttribute(): string
    {
        return $this->name ?: $this->full_name;
    }
    
    public function getTokenAttribute(): string
    {
        return $this->github_token ?: config('services.github.token');
    }
}
```

#### 既存モデルの更新: `GitHubView`
```php
class GitHubView extends Model
{
    protected $fillable = [
        'repository_id', 'project', 'date', 'count', 'uniques'
    ];
    
    // 新規リレーション
    public function repository(): BelongsTo
    {
        return $this->belongsTo(GitHubRepository::class);
    }
    
    // 新規スコープ
    public function scopeForRepository($query, $repositoryId)
    {
        return $query->where('repository_id', $repositoryId);
    }
    
    public function scopeWithRepository($query)
    {
        return $query->with('repository');
    }
}
```

### 3. コマンドの改良

#### `FetchGitHubViews`コマンドの更新
```php
class FetchGitHubViews extends Command
{
    protected $signature = 'github:fetch-views {--repository= : 特定のリポジトリIDを指定} {--test : テスト実行}';
    
    public function handle()
    {
        // 特定のリポジトリが指定されている場合
        if ($repositoryId = $this->option('repository')) {
            $repositories = GitHubRepository::where('id', $repositoryId)->active()->get();
        } else {
            // すべてのアクティブなリポジトリを取得
            $repositories = GitHubRepository::active()->get();
        }
        
        foreach ($repositories as $repository) {
            $this->fetchRepositoryViews($repository);
        }
    }
    
    private function fetchRepositoryViews(GitHubRepository $repository): array
    {
        $token = $repository->token; // リポジトリ専用トークンまたはデフォルトトークン
        
        // リポジトリIDを使用してデータを保存
        $result = GitHubView::updateOrCreate(
            [
                'repository_id' => $repository->id,
                'project' => $repository->full_name,
                'date' => $viewDate
            ],
            [
                'count' => $view['count'],
                'uniques' => $view['uniques']
            ]
        );
    }
}
```

### 4. データ移行の実装

#### 移行コマンド: `MigrateExistingGitHubViews`
```php
class MigrateExistingGitHubViews extends Command
{
    protected $signature = 'github:migrate-existing-views {--dry-run : 実際の更新は行わず、プレビューのみ}';
    
    public function handle()
    {
        // repository_idがnullの既存データを取得
        $orphanedViews = GitHubView::whereNull('repository_id')->get();
        
        foreach ($orphanedViews as $view) {
            // プロジェクト名からowner/repoを分離
            [$owner, $repo] = explode('/', $view->project);
            
            // 対応するリポジトリを検索または作成
            $repository = GitHubRepository::firstOrCreate([
                'owner' => $owner,
                'repo' => $repo,
            ], [
                'name' => $view->project,
                'description' => "自動移行されたリポジトリ: {$view->project}",
                'is_active' => true,
            ]);
            
            // GitHubViewのrepository_idを更新
            $view->update(['repository_id' => $repository->id]);
        }
    }
}
```

### 5. Webインターフェースの更新

#### コントローラーの更新
```php
class GitHubViewController extends Controller
{
    public function index(Request $request): View
    {
        $query = GitHubView::with('repository');
        
        // リポジトリでフィルタリング
        if ($request->has('repository_id') && $request->repository_id) {
            $query->forRepository($request->repository_id);
        }
        
        // リポジトリ一覧を取得（フィルター用）
        $repositories = \App\Models\GitHubRepository::orderBy('name')->get();
        
        return view('github.views', compact('views', 'repositories', 'projects'));
    }
}
```

### 6. 初期データの投入

#### シーダーファイル: `GitHubRepositorySeeder`
```php
class GitHubRepositorySeeder extends Seeder
{
    public function run(): void
    {
        $repositories = [
            [
                'owner' => 'shimanamisan',
                'repo' => 'CsharpSample',
                'name' => 'C# サンプルプロジェクト',
                'description' => 'C#の学習用サンプルプロジェクト',
                'is_active' => true,
                'github_token' => null, // 環境設定のトークンを使用
            ],
        ];
        
        foreach ($repositories as $repo) {
            GitHubRepository::updateOrCreate([
                'owner' => $repo['owner'],
                'repo' => $repo['repo'],
            ], $repo);
        }
    }
}
```

## 📊 変更の効果

### ✅ 改善された点

1. **複数リポジトリ対応**
   - データベースでリポジトリ情報を管理
   - 動的なリポジトリ追加・削除が可能

2. **柔軟な設定管理**
   - リポジトリごとに個別のGitHubトークン設定が可能
   - リポジトリの有効/無効切り替えが可能

3. **データの整合性向上**
   - 外部キー制約による参照整合性の保証
   - リポジトリ削除時の関連データの自動クリーンアップ

4. **拡張性の向上**
   - 新しいリポジトリの追加が容易
   - リポジトリごとの個別設定が可能

5. **後方互換性の維持**
   - 既存のAPIエンドポイントはそのまま動作
   - 既存のデータは自動的に移行

### 🔧 技術的な改善

1. **データベース設計**
   - 正規化されたテーブル構造
   - 適切なインデックスと制約

2. **モデル設計**
   - Eloquentリレーションの活用
   - アクセサとスコープの実装

3. **コマンド設計**
   - オプション引数による柔軟な実行
   - エラーハンドリングの強化

4. **移行戦略**
   - 既存データの自動移行
   - ドライラン機能による安全な移行

## 🚀 使用方法

### 1. 新しいリポジトリの追加
```bash
# データベースに直接追加
php artisan tinker
>>> App\Models\GitHubRepository::create([
    'owner' => 'your-username',
    'repo' => 'your-repo',
    'name' => 'プロジェクト名',
    'description' => '説明',
    'is_active' => true
]);
```

### 2. コマンドの実行
```bash
# すべてのアクティブなリポジトリのデータを取得
php artisan github:fetch-views

# 特定のリポジトリのみ（ID指定）
php artisan github:fetch-views --repository=1

# テスト実行
php artisan github:fetch-views --test
```

### 3. データ移行（既存環境向け）
```bash
# ドライラン（プレビューのみ）
php artisan github:migrate-existing-views --dry-run

# 実際の移行実行
php artisan github:migrate-existing-views
```

## 📝 今後の拡張可能性

1. **リポジトリ管理画面**
   - Webインターフェースでのリポジトリ追加・編集・削除
   - リポジトリごとの設定管理

2. **権限管理**
   - ユーザーごとのリポジトリアクセス制御
   - 組織レベルの管理機能

3. **監視・アラート機能**
   - リポジトリごとの異常検知
   - メール通知やSlack通知

4. **レポート機能**
   - リポジトリ間の比較分析
   - 期間別の統計レポート

## 🎯 結論

今回の修正により、単一リポジトリ管理から複数リポジトリ対応システムへの移行が完了しました。これにより、より柔軟で拡張性の高いGitHub訪問数監視システムが実現され、複数のプロジェクトを効率的に管理できるようになりました。

既存の機能は後方互換性を保ちながら、新しい機能が追加されており、システムの安定性と拡張性の両方が向上しています。

