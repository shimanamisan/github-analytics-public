name: Mirror to Public Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false  # ← ⭐ これを追加！
          # これにより、デフォルトのGITHUB_TOKENがgit設定に残らない

      - name: Remove sensitive files
        run: |
          rm -f .env
          rm -f deploy/prod/.env
          rm -f deploy/prod/.env.production
          rm -rf .github/workflows/deploy.yml
          rm -rf .github/workflows/mirror-to-public.yml
          rm -f config/secrets.php
          echo ".env" >> .gitignore
          echo "*.local" >> .gitignore

      - name: Create README for public repo
        run: |
          cat > README-PUBLIC.md << 'EOF'
          # GitHub Analytics

          **注意:** このリポジトリはポートフォリオ展示用の公開ミラーです。  
          実際の本番環境デプロイはプライベートリポジトリで管理されています。

          ## 概要
          GitHub APIを活用した分析プラットフォームです。リポジトリの統計情報やアクティビティをリアルタイムで可視化します。

          ## 主な機能
          - **Laravel基盤**: 堅牢なPHPフレームワークによる開発
          - **Dockerコンテナ化**: 再現性の高いデプロイ環境
          - **リアルタイム分析**: GitHub Webhookによる即時データ更新
          - **可視化ダッシュボード**: 直感的なデータ表示

          ## 技術スタック
          - Backend: Laravel 10.x
          - Frontend: Livewire, Tailwind CSS
          - Database: MySQL 8.0
          - Infrastructure: Docker, Nginx

          ## 注意事項
          このリポジトリは参照・学習目的で公開されています。  
          デプロイ手順や環境構築の詳細はドキュメントを参照してください。

          ## ライセンス
          MIT License
          EOF
          
          mv README-PUBLIC.md README.md

      - name: Push to public repository
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          # Git設定
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 既存のgit認証情報をクリア（念のため）
          git config --global --unset-all credential.helper || true
          git config --local --unset-all credential.helper || true
          
          # リモート追加
          git remote add public "https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/shimanamisan/github-analytics-public.git"
          
          # コミット
          git add -A
          git commit -m "Mirror from private repo ($(date '+%Y-%m-%d %H:%M:%S'))" || echo "No changes to commit"
          
          # プッシュ
          git push public main --force
          
          echo "✅ Mirror completed successfully!"