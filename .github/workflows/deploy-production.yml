name: Deploy to Production

on:
  push:
    branches:
      - main
      - develop  # é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆã‚‚è¨±å¯
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Build and push App image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/docker/php/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/app:latest
            ${{ env.REGISTRY }}/${{ github.repository }}/app:${{ steps.meta.outputs.timestamp }}
            ${{ env.REGISTRY }}/${{ github.repository }}/app:${{ steps.meta.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: prod

      - name: Build and push Web (Nginx) image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/docker/nginx/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/web:latest
            ${{ env.REGISTRY }}/${{ github.repository }}/web:${{ steps.meta.outputs.timestamp }}
            ${{ env.REGISTRY }}/${{ github.repository }}/web:${{ steps.meta.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push DB (MySQL) image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/docker/mysql/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/db:latest
            ${{ env.REGISTRY }}/${{ github.repository }}/db:${{ steps.meta.outputs.timestamp }}
            ${{ env.REGISTRY }}/${{ github.repository }}/db:${{ steps.meta.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "## ðŸš€ Images Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.REGISTRY }}/${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.meta.outputs.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.meta.outputs.sha_short }}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: self-hosted
    # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
    if: github.ref == 'refs/heads/main'
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}

    steps:
      - name: Checkout deployment scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            deploy/scripts
            deploy/prod

      - name: Setup production .env file
        env:
          PRODUCTION_ENV: ${{ secrets.PRODUCTION_ENV }}
        run: |
          DEPLOY_DIR="/home/$(whoami)/deploy/github-analytics"
          mkdir -p "$DEPLOY_DIR"

          # .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦é…ç½®
          if [ -n "$PRODUCTION_ENV" ]; then
            echo "$PRODUCTION_ENV" | base64 --decode > "$DEPLOY_DIR/.env"
            echo "âœ… .env file created from secrets"
          else
            echo "âš ï¸ PRODUCTION_ENV secret not found"
            if [ ! -f "$DEPLOY_DIR/.env" ]; then
              echo "âŒ .env file does not exist"
              exit 1
            fi
            echo "â„¹ï¸ Using existing .env file"
          fi

      - name: Deploy application
        run: |
          cd deploy/scripts
          chmod +x deploy.sh
          ./deploy.sh

      - name: Deployment summary
        run: |
          echo "## âœ… Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY